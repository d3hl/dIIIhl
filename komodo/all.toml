[[server]]
name = "kmd0"
[server.config]
address = "https://host.docker.internal:8120"
enabled = true
passkey = "g1ImlB3yyCCcLct6Lt2Ffx5969oVpCGR"

##

[[server]]
name = "kmd1"
[server.config]
address = "https://10.10.10.36:8120"
enabled = true
passkey = "k9sFdHxaIyKy00rel7gyxDdGkN4C8Ft8"

##

[[stack]]
name = "authentik"
[stack.config]
server = "kmd1"
links = ["https://auth.d3adc3ii.cc"]
poll_for_updates = true
auto_update = true
auto_update_all_services = true
file_contents = """
services:
  postgresql:
    env_file:
    - .env
    environment:
      POSTGRES_DB: ${PG_DB:-authentik}
      POSTGRES_PASSWORD: ${PG_PASS:?database password required}
      POSTGRES_USER: ${PG_USER:-authentik}
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 20s
      test:
      - CMD-SHELL
      - pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}
      timeout: 5s
    image: docker.io/library/postgres:16-alpine
    restart: unless-stopped
    volumes:
    - database:/var/lib/postgresql/data
  redis:
    command: --save 60 1 --loglevel warning
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 20s
      test:
      - CMD-SHELL
      - redis-cli ping | grep PONG
      timeout: 3s
    image: docker.io/library/redis:alpine
    restart: unless-stopped
    volumes:
    - redis:/data
  server:
    command: server
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
    - .env
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgresql
      AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS}
      AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.8.4}
    ports:
    - ${COMPOSE_PORT_HTTP:-9000}:9000
    - ${COMPOSE_PORT_HTTPS:-9443}:9443
    restart: unless-stopped
    volumes:
    - ${CAPP}/media:/media
    - ${CAPP}/custom-templates:/templates
  worker:
    command: worker
    depends_on:
      postgresql:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
    - .env
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgresql
      AUTHENTIK_POSTGRESQL__NAME: ${PG_DB:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${PG_PASS}
      AUTHENTIK_POSTGRESQL__USER: ${PG_USER:-authentik}
      AUTHENTIK_REDIS__HOST: redis
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY:?secret key required}
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.8.4}
    restart: unless-stopped
    user: root
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - ${CAPP}/media:/media
    - ${CAPP}/certs:/certs
    - ${CAPP}/custom-templates:/templates
volumes:
  database:
    driver: local
  redis:
    driver: local
"""
environment = """
CAPP=/mnt/cFS/appdata/authentik
PG_PASS=[[AUTHENTIK_PG_PASS]]
AUTHENTIK_SECRET_KEY=[[AUTHENTIK_SECRET_KEY]]
AUTHENTIK_ERROR_REPORTING__ENABLED=true
"""

##

[[stack]]
name = "homepage"
tags = ["kmd1"]
[stack.config]
server = "kmd1"
links = ["https://homepage.d3adc3ii.cc"]
poll_for_updates = true
auto_update = true
auto_update_all_services = true
linked_repo = "dIIIhl"
run_directory = "komodo/homepage"
file_paths = ["compose.yaml"]
config_files = [
  { path = "config/services.yaml" },
  { path = "config/settings.yaml" },
  { path = "config/docker.yaml" },
  { path = "config/bookmarks.yaml" }
]
environment = """
HOMEPAGE_DATA_DIR= /mnt/cFS/appdata/komodo/repos/dIIIhl/komodo/homepage
HOMEPAGE_ALLOWED_HOSTS= "homepage.d3adc3ii.cc,homepage.d3adc3ii.site,10.10.10.36:3731"
PGID= 1000
PUID= 1000 
# Site Config
HOMEPAGE_VAR_TITLE= "d3 Homepage"
HOMEPAGE_VAR_FAVICON= "/icons/d3logo.png"
HOMEPAGE_VAR_IMG_URL= "/images/hack.jpg"
HOMEPAGE_VAR_HEADER_STYLE= boxed #boxedWidgets

HOMEPAGE_VAR_IMG_BLUR= md
HOMEPAGE_VAR_IMG_SATURATE= 50
HOMEPAGE_VAR_IMG_BRIGHTNESS= 50
HOMEPAGE_VAR_IMG_OPACITY=70
HOMEPAGE_VAR_USE_EQUAL_HEIGHTS= true
HOMEAGE_VAR_DISABLE_COLLAPSE= true


### GLANCES WIDGET SETTINGS
HOMEPAGE_VAR_GL11_URL= http://10.10.10.11:61208
HOMEPAGE_VAR_GL11_VERSION= 4 # required only if running glances v4 or higher, defaults to 3
HOMEPAGE_VAR_GL11_CPU= false # optional, enabled by default, disable by setting to false
HOMEPAGE_VAR_GL11_MEM= false # optional, enabled by default, disable by setting to false
HOMEPAGE_VAR_GL11_CPUTEMP= true # disabled by default
HOMEPAGE_VAR_GL11_UPTIME= true # disabled by default
HOMEPAGE_VAR_GL11_LABEL= pve11 # optional

HOMEPAGE_VAR_GL12_URL= http://10.10.10.12:61208
HOMEPAGE_VAR_GL12_VERSION= 4 
HOMEPAGE_VAR_GL12_CPU= false 
HOMEPAGE_VAR_GL12_MEM= false 
HOMEPAGE_VAR_GL12_CPUTEMP= true 
HOMEPAGE_VAR_GL12_UPTIME= true 
HOMEPAGE_VAR_GL12_LABEL= pve12 

HOMEPAGE_VAR_GL13_URL= http://10.10.10.13:61208
HOMEPAGE_VAR_GL13_VERSION= 4
HOMEPAGE_VAR_GL13_CPU= false 
HOMEPAGE_VAR_GL13_MEM= false 
HOMEPAGE_VAR_GL13_CPUTEMP= true 
HOMEPAGE_VAR_GL13_UPTIME= true 
HOMEPAGE_VAR_GL13_LABEL= pve13 

#### INFRA ####################################################################################################################################################################################################
# Proxmox
HOMEPAGE_VAR_PROXMOX_ICON= "/icons/proxmox-light.png"
HOMEPAGE_VAR_PROXMOX_URL_PVE11= "https://pve.d3adc3ii.cc"
HOMEPAGE_VAR_PROXMOX_IP_PVE11="https://10.10.10.10:8006"
#HOMEPAGE_VAR_PROXMOX_USER=homepage@pve!homepage 
HOMEPAGE_VAR_PROXMOX_SECRET=bd9d76fb-00a6-4e4d-af8a-66f0606ba7fc
HOMEPAGE_VAR_PBS_URL= "https://pbs.d3adc3ii.site"
# Truenas
HOMEPAGE_VAR_TRUENAS_ICON= "/icons/truenas-scale-light.png"
HOMEPAGE_VAR_TRUENAS_URL= "https://truenas.d3adc3ii.cc"
HOMEPAGE_VAR_TRUENAS_KEY=4-wEIiKMeFJpOJPyS2Y2658EQGbxZkBJUcQyBQvQoRzjggfnOIXNN7z8w7OvKpgK6C
HOMEPAGE_VAR_TRUENAS_ENABLEDPOOL= true
# Komodo
HOMEPAGE_VAR_KOMODO_ICON= "/icons/docker-light.png"
HOMEPAGE_VAR_KOMODO_URL= "https://komodo.d3adc3ii.cc"
HOMEPAGE_VAR_KOMODO_IPURL= "http://10.10.10.25:9120"
HOMEPAGE_VAR_KOMODO_KEY=K-69zvNUYoxn5KREW5nVpLqeLa741U7NHmPXoEx4S1
HOMEPAGE_VAR_KOMODO_SECRET=S-5hhHrLWPfLHPJCRGBMV2auU7QsqfUaGrTJYuOW9M

#### DOMAIN ####################################################################################################################################################################################################
# Authentik
HOMEPAGE_VAR_AUTHENTIK_ICON= "/icons/authentik-light.png"
HOMEPAGE_VAR_AUTHENTIK_URL= "https://auth.d3adc3ii.cc"
HOMEPAGE_VAR_AUTHENTIK_KEY= "ZnhLrOvUoWZfHcQpFrteQVekOjpGQh48lXEVFn34HvGtT8eJoyhgaNYWb2mI"
# DNS
HOMEPAGE_VAR_DNS_ICON= "/icons/technitium-light.png"
HOMEPAGE_VAR_DNS_URL= "https://ns.d3adc3ii.site"
HOMEPAGE_VAR_DNS_KEY= [[HOMEPAGE_VAR_DNS_KEY]]
HOMEPAGE_VAR_DNS_RANGE: LastDay # optional, defaults to LastHour
# GoDoxy
HOMEPAGE_VAR_GODOXY_ICON= "/icons/godoxy-light.png"
HOMEPAGE_VAR_GODOXY_URL= "https://doxy.d3hl.site"
# PANGOLIN
HOMEPAGE_VAR_PANGOLIN_ICON= "/icons/pangolin-light.png"
HOMEPAGE_VAR_PANGOLIN_URL= "https://pangolin.d3adc3ii.cc"

#### NETWORK ####################################################################################################################################################################################################
# NetAlertX 
HOMEPAGE_VAR_NETALERTX_ICON= "/icons/netalertx-light.png"
HOMEPAGE_VAR_NETALERTX_URL= "https://netalertx.d3adc3ii.site"
HOMEPAGE_VAR_NETALERTX_KEY="t_pJ26L2qEeUcR6bz5RCGI"
HOMEPAGE_VAR_NETALERTX_FIELDS= ["connected","down_alerts","new_devices"] 
# UPTIME KUMA
HOMEPAGE_VAR_KUMA_ICON= "/icons/uptime-kuma-light.png"
HOMEPAGE_VAR_KUMA_URL= "https://uptime.d3adc3ii.cc"
HOMEPAGE_VAR_KUMA_KEY=uk1_CJtVJXDT8DFll97KXiPPXb6dEWHpOdBZXymKWLPn
# PHPIPAM
HOMEPAGE_VAR_PHPIPAM_URL= "https://phpipam.d3adc3ii.cc/"
HOMEPAGE_VAR_PHPIPAM_ICON= "sh-phpmyadmin-light"
# Nautobot
HOMEPAGE_VAR_NAUTOBOT_URL= "https://nautobot.d3adc3ii.cc/"
HOMEPAGE_VAR_NAUTOBOT_ICON= "/icons/netbox-light.png"
# NETBOX CLOUD
HOMEPAGE_VAR_NETBOX_ICON= "/icons/netbox-light.png"
HOMEPAGE_VAR_NETBOXCL_URL= "https://wmfk3018.cloud.netboxapp.com"
# NETBOX CONSOLE
HOMEPAGE_VAR_NETBOXCS_URL= "https://console.netboxlabs.com/"# NETBOX CONSOLE
HOMEPAGE_VAR_NETBOXCS_URL= "https://console.netboxlabs.com/"

#### MONITORING  ####################################################################################################################################################################################################
# Beszel
HOMEPAGE_VAR_BESZEL_ICON= "/icons/beszel-light.png"
HOMEPAGE_VAR_BESZEL_URL= "https://beszel.d3adc3ii.cc"
HOMEPAGE_VAR_BESZEL_USERNAME= "d3tech@pm.me"
HOMEPAGE_VAR_BESZEL_PASSWORD= "KVG6qpu0rnb-ybd9etn" 
HOMEPAGE_VAR_BESZEL_VERSION= "2"
HOMEPAGE_VAR_BESZEL_SYSTEMID_pve11= pve11
HOMEPAGE_VAR_BESZEL_SYSTEMID_pve12= pve12
HOMEPAGE_VAR_BESZEL_SYSTEMID_pve13= pve13
HOMEPAGE_VAR_BESZEL_SYSTEMID_pbs= pbs
HOMEPAGE_VAR_BESZEL_FIELDS= ["cpu","memory","disk","network"]
# SPEEDTEST
HOMEPAGE_VAR_SPEEDTEST_ICON= "sh-speedtest-tracker-light"
HOMEPAGE_VAR_SPEEDTEST_URL= "https://speedtest.d3adc3ii.site"
# Wazuh
HOMEPAGE_VAR_WAZUH_ICON= "/icons/wazuh-light.png"
HOMEPAGE_VAR_WAZUH_URL= "https://wazuh.d3adc3ii.site"
# APPRISE-API
HOMEPAGE_VAR_APPRISE_ICON= "/icons/gotify-dark.png"
HOMEPAGE_VAR_APPRISE_URL= "http://192.168.2.33:8000"
# Healthchecks
HOMEPAGE_VAR_HEALTHCHECKS_ICON= "/icons/healthchecks-light.png"
HOMEPAGE_VAR_HEALTHCHECKS_URL= "http://health.d3adc3ii.site"

#### BACKUP ####################################################################################################################################################################################################
# PBS
HOMEPAGE_VAR_PBS_URL="https://pbs.d3hl.site"
HOMEPAGE_VAR_PBS_USER=homepage@pbs!homepage
HOMEPAGE_VAR_PBS_SECRET=56ff3a13-0620-432b-b173-d048b1298a50
# Backrest
HOMEPAGE_VAR_BACKREST_ICON= "/icons/backrest-light.png"
HOMEPAGE_VAR_BACKREST_URL= "https://backrest.d3adc3ii.site"

# Remote-Backups
HOMEPAGE_VAR_REMOTEBACKUP_ICON= "/icons/proxmox-light.png"
HOMEPAGE_VAR_REMOTEBACKUP_URL= "https://dashboard.remote-backups.com"


#### MEDIA ####################################################################################################################################################################################################
# Jellyfin
HOMEPAGE_VAR_JELLY_ICON= "/icons/jellyfin-light.png"
HOMEPAGE_VAR_JELLY_URL= "https://jelly.d3adc3ii.site"
HOMEAGE_VAR_JELLY_WIDGETURL= "http://10.10.10.27:8096"
HOMEPAGE_VAR_JELLY_KEY=a6a45c61dd1d4f059b02fa22ad8c0ef3
HOMEPAGE_VAR_JELLY_ENABLEBLOCK=true
HOMEPAGE_VAR_JELLY_NOWPLAY=false

# Immich
HOMEPAGE_VAR_IMMICH_ICON = "/icons/immich-light.png"
HOMEPAGE_VAR_IMMICH_URL= "https://immich.d3hl.site"
HOMEPAGE_VAR_IMMICH_KEY=W7IJnjVEIhc7d72AAm4sxJ49YJI1kdtkiVvmCZipVqc
HOMEPAGE_VAR_IMMICH_VERSION= 2
HOMEPAGE_VAR_IMMICH_FIELDS= ["storage","photos","videos"] 
# Stash
HOMEPAGE_VAR_STASH_ICON= "/icons/stash-light.png"
HOMEPAGE_VAR_STASH_URL= "https://stash.d3adc3ii.site"
HOMEPAGE_VAR_STASH_USER= "d3adc3ii"
HOMEPAGE_VAR_QBIT_API= "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJkMyIsInN1YiI6IkFQSUtleSIsImlhdCI6MTc0NjAzOTExOX0.OQqokQMNgdCRNxfPOQGOTFH4GCB0pQvZbIS9orkgkrg"

#### ACCESS ####################################################################################################################################################################################################
# Guacamole
HOMEPAGE_VAR_GUACAMOLE_ICON= "/icons/apache-guacamole-light.png"
HOMEPAGE_VAR_GUACAMOLE_URL= "https://guaca.d3adc3ii.site/guacamole"
HOMEPAGE_VAR_GUACAMOLEEXT_URL= "https://guaca.d3adc3ii.cc/guacamole"
# SHELLHUB
HOMEPAGE_VAR_SHELLHUB_ICON= "sh-shellhub-light"
HOMEPAGE_VAR_SHELLHUB_URL= "http://192.168.2.33"

#### LOGGING ####################################################################################################################################################################################################
# Grafana
HOMEPAGE_VAR_GRAFANA_ICON= "/icons/grafana-light.png"
HOMEPAGE_VAR_GRAFANA_URL= "https://d3adc3ii.grafana.net/dashboards"
HOMEPAGE_VAR_GRAFANA_URL= "https://grafana.d3adc3ii.cc"
HOMEPAGE_VAR_GRAFANAC_URL= "https://grafana.d3adc3ii.cc/d/n5bu_kv45/traefik-official-standalone-dashboard"


HOMEPAGE_VAR_INFLUX_ICON= "sh-influx-light"
HOMEPAGE_VAR_INFLUX_URL= "https://influxdb.d3adc3ii.site"
# Scutiny
HOMEPAGE_VAR_SCRUTINY_ICON= "/icons/scrutiny-light.png"
HOMEPAGE_VAR_SCRUTINY_URL= "https://scrutiny.d3adc3ii.cc" 
# Dozzle
HOMEPAGE_VAR_DOZZLE_ICON= "sh-dozzle-light"
HOMEPAGE_VAR_DOZZLE_URL= "https://dozzle.d3adc3ii.site"
# Pulse
HOMEPAGE_VAR_PULSEXT_ICON= "sh-proxmox-light"
HOMEPAGE_VAR_PULSEXT_URL= "https://pulse.d3adc3ii.cc"

#### APPS ####################################################################################################################################################################################################
# Actual Budget
HOMEPAGE_VAR_ACTUAL_ICON= "sh-actual-budget-light"
HOMEPAGE_VAR_ACTUAL_URL= "https://actual.d3adc3ii.site"
# Sensei
HOMEPAGE_VAR_SENSEI_ICON= "sh-sentry-light"
HOMEPAGE_VAR_SENSEI_URL= "https://statement.d3adc3ii.site"
# Semaphore
HOMEPAGE_VAR_SEMAPHORE_ICON= "/icons/semaphore-ui-light.png"
HOMEPAGE_VAR_SEMAPHORE_URL= "https://semaphore.d3adc3ii.site"
# Aria2
HOMEPAGE_VAR_ARIA_ICON= "sh-aria2-light"
HOMEPAGE_VAR_ARIA_URL= "https://dl.d3adc3ii.site"
# NZBGET
HOMEPAGE_VAR_NZBGET_ICON= "sh-nzbget-light"
HOMEPAGE_VAR_NZBGET_URL= "https://nzbget.d3adc3ii.site"
# Karakeep
HOMEPAGE_VAR_KARAKEEP_ICON= "/icons/karakeep.png"
HOMEPAGE_VAR_KARAKEEP_URL= "https://kara.d3adc3ii.cc"
# Wallos
HOMEPAGE_VAR_WALLOS_ICON= "/icons/wallos-light.png"
HOMEPAGE_VAR_WALLOS_URL= "https://wallos.d3adc3ii.cc"
# Ommni Tools
HOMEPAGE_VAR_OMNITOOLS_ICON= "sh-omnitools-light"
HOMEPAGE_VAR_OMNITOOLS_URL= "https://omnitools.d3adc3ii.cc"

#### TOOLS ####################################################################################################################################################################################################

#### EXTRAS ####################################################################################################################################################################################################
# Selfhst-icons
HOMEPAGE_VAR_SELFHST_ICON= "sh-selfh-st-light" 
HOMEPAGE_VAR_SELFHST_URL= "https://selfhst-icons.d3adc3ii.cc"

###################   CORP    ##################### 

# Komodo
HOMEPAGE_VAR_KOMODOCORP_URL="http://10.203.1.121:9120"
# Fenrus
HOMEPAGE_VAR_FENRUS_ICON="sh-fenrus"
HOMEPAGE_VAR_FENRUS_URL="http://10.203.1.120:3222"
# PVECORP
HOMEPAGE_VAR_PVECORP_URL="https://10.203.1.113:8006"
# UNIMUS  
HOMEPAGE_VAR_UNIMUS_ICON="sh-unimus-light"
HOMEPAGE_VAR_UNIMUS_URL="http://10.203.1.120:8085"

### GL1 ###
# PVE11
HOMEPAGE_VAR_PVE11_URL= "https://pve11.d3adc3ii.cc"
HOMEPAGE_VAR_PVE12_URL= "10.10.10.12"
HOMEPAGE_VAR_PVE13_URL= "10.10.10.13"
HOMEPAGE_VAR_GLANCES_PVE11= "http://10.10.10.11:61208"
HOMEPAGE_VAR_GLANCES_PVE12= "http://10.10.10.12:61208"
HOMEPAGE_VAR_GLANCES_PVE13= "http://10.10.10.13:61208"
"""

##

[[stack]]
name = "komodo-ee"
[stack.config]
server = "kmd0"
file_contents = """
---

services:
  ansible:
    image: ghcr.io/bpbradley/ansible/komodo-ee:v1.3 # or latest
    extra_hosts:
      - host.docker.internal:host-gateway
    volumes:
      - ./ansible:/ansible # Mount ansible files into container
      - /mnt/cFS/appdata/komodo/komodo_ansible:/root/.ssh/id_ed25519:ro # Make sure the user you run the container has read access to the key
    env_file:
      - .env
    environment:
      ANSIBLE_HOST_KEY_CHECKING: ${ANSIBLE_HOST_KEY_CHECKING:-false} # Necessary for automation, unless you manage known_hosts and map it into container
    command: "sleep 3600" # this keeps the container running by default, which will help with testing so you can exec into it temporarily
"""
environment = """
PUID=1000
PGID=1000
"""

##

[[stack]]
name = "newt"
[stack.config]
server = "kmd0"
project_name = "pangolin"
auto_update = true
auto_update_all_services = true
file_contents = """
services:
  newt:
    image: fosrl/newt
    container_name: newt
    restart: unless-stopped
    environment:
      - PANGOLIN_ENDPOINT=https://pangolin.d3adc3ii.cc
      - NEWT_ID=ixrel8im3yl6fgh
      - NEWT_SECRET=zuad2oldb22s0oypic8y3y8hdj9tk52muf3r176pss0g1zgm
      - ACCEPT_CLIENTS=true
      - DOCKER_SOCKET=/var/run/docker.sock
networks:
  default:
    name: pangolin_default
"""
environment = """
  # VARIABLE = value
"""

##

[[stack]]
name = "omni-infra-provider-bare-metal"
[stack.config]
server = "kmd0"
file_contents = """
services:
    omni-infra-provider-bare-metal:
        container_name: omni-bare-metal-infra-provider
        restart: always
        network_mode: host
        env_file:
          - .env
        image: ghcr.io/siderolabs/omni-infra-provider-bare-metal:v0.1.0
        command: --api-advertise-address=10.10.10.211
"""
environment = """
OMNI_ENDPOINT=https://omni.d3hl.site
OMNI_SERVICE_ACCOUNT_KEY=eyJuYW1lIjoiYmFyZS1tZXRhbCIsInBncF9rZXkiOiItLS0tLUJFR0lOIFBHUCBQUklWQVRFIEtFWSBCTE9DSy0tLS0tXG5cbnhWZ0VhU3NFWVJZSkt3WUJCQUhhUnc4QkFRZEFlWHQ5N0pydlRBZWR6cGtSTGZXc1d0ekhwUld2QzNMbVxuOHV1RmdVL1BIUTBBQVFDZXlycXpsUTVvR1oveGwvbk1uTXBYcXIxMFpVdXR0RUlQZU9sd1dMMnZseElNXG56VG84WW1GeVpTMXRaWFJoYkVCcGJtWnlZUzF3Y205MmFXUmxjaTV6WlhKMmFXTmxZV05qYjNWdWRDNXZcbmJXNXBMbk5wWkdWeWJ5NWtaWFkrd3NBWkJCTVdDZ0NMQllKcEt3UmhCWWtCNFRPQUF3c0pCd2tRQThoMlxuenY3Um9oeEZGQUFBQUFBQUhBQWdjMkZzZEVCdWIzUmhkR2x2Ym5NdWIzQmxibkJuY0dwekxtOXlaN2M4XG5WYlF2dVAyclg5T0NlUk4xN1BPNS9KWkRYcW9rd1NnK05tT0c2UFFDQlJVSUNnNE1CQllDQUFFQ0dRRUNcbm13TUNIZ0VXSVFSaC80aDdsMnZVTjZxZXJ1RUR5SGJPL3RHaUhBQUFsYUFCQUtOTWJyV2tIY29tSzJQMVxuOXVpd1FzbWxzaVJhaGRhVk9JUk9UQ2xnNjYxakFRRHBlNno4YjU5RTVRTWo0L0ltWEw5UWJXTHdNRkliXG5WekdHWHNWblphOGFEc2RkQkdrckJHRVNDaXNHQVFRQmwxVUJCUUVCQjBEQjRFM3hMazNIWGtHL2M2UWtcblNvUEJlNEpqTkkrVTBLTVlqMHRoZEd6ZmZRTUJDQWNBQVA5bXRkTXZZMW54cWJwNGNJOVorRFRxcGZSRFxud3ZGbWMxYTBRTm5pTEIvajBCTjl3c0FFQkJnV0NnQjJCWUpwS3dSaEJZa0I0VE9BQ1JBRHlIYk8vdEdpXG5IRVVVQUFBQUFBQWNBQ0J6WVd4MFFHNXZkR0YwYVc5dWN5NXZjR1Z1Y0dkd2FuTXViM0pucERuTzNYVldcbnE1QkNhQjMveTgvZW82MUR2M3lqQ2lvVFB0bjBlVHhkK1IwQ213d1dJUVJoLzRoN2wydlVONnFlcnVFRFxueUhiTy90R2lIQUFBMjNzQS9qS3FpSlhTeGlCVU9vSkxhRTUvY05oNkNaQnl3aW8vQ1d0RDltaFJCUWdtXG5BUDBRTDVXa0gxRllyelZFN1pnNHdYanZkRUJvT0p6MTBLZC81alMyaVBkN0J3PT1cbj1wUC9wXG4tLS0tLUVORCBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLSJ9
"""

##

[[stack]]
name = "twingate"
[stack.config]
server = "kmd1"
file_contents = """
services:
  twingate_connector:
    container_name: twingate
    image: twingate/connector:latest
    restart: always
    env_file:
    - .env
    sysctls:
      net.ipv4.ping_group_range: "0 65535"
"""
environment = """
TWINGATE_NETWORK=d3net
TWINGATE_ACCESS_TOKEN=eyJhbGciOiJFUzI1NiIsImtpZCI6Ii1NeDFKWVRyS3gzQjZ0T0NuMUFoX3J2OTdRNERzYksybUVuekZHczNnWG8iLCJ0eXAiOiJEQVQifQ.eyJhdWRzIjpudWxsLCJudCI6IkFOIiwiYWlkIjoiNjcxOTkxIiwiZGlkIjoiMjc1NTg0MyIsInJudyI6MTc2NDU3MTE1NSwianRpIjoiNDI4NDY3ZTgtODEwNy00ZmY3LThlNmQtNzgxNWI0ZGMxMmFiIiwiaXNzIjoidHdpbmdhdGUiLCJhdWQiOiJkM25ldCIsImV4cCI6MTc2NDU3NDUxMSwiaWF0IjoxNzY0NTcwOTExLCJ2ZXIiOiI0IiwidGlkIjoiMTAzNTY0Iiwicm5ldGlkIjoiMTM1OTMxIn0.CdZaPpe231AQ5pp2soFm5jpcRavScNLmv2YV4Xbn9zESR-f1FzUcB44hgoiLRm3zKzL-YJQR7XinfmYOx4PGmg
TWINGATE_REFRESH_TOKEN=Ecgu9VB-ikKlX9bAU1ntj-36WHVbIRul_mM2i3UxrkBitEPEWlUUO0xYUesxHLB01aGrl02FfeJ4KF7jW7haX4BifZiDdrf5B11GOkny69rfw05TVMXYCsgjb2yI9Zy9EFscQQ
TWINGATE_LABEL_HOSTNAME="`hostname`"
"""

##

[[repo]]
name = "dIIIhl"
[repo.config]
server = "kmd0"
git_provider = "Github.com"
git_account = "d3hl"
repo = "d3hl/dIIIhl"

##

[[procedure]]
name = "Backup Core Database"
description = "Triggers the Core database backup at the scheduled time."
tags = ["system"]
config.schedule = "Every day at 01:00"

[[procedure.config.stage]]
name = "Stage 1"
enabled = true
executions = [
  { execution.type = "BackupCoreDatabase", execution.params = {}, enabled = true }
]

##

[[procedure]]
name = "Global Auto Update"
description = "Pulls and auto updates Stacks and Deployments using 'poll_for_updates' or 'auto_update'."
tags = ["system"]
config.schedule = "Every day at 03:00"

[[procedure.config.stage]]
name = "Stage 1"
enabled = true
executions = [
  { execution.type = "GlobalAutoUpdate", execution.params = {}, enabled = true }
]

##

[[action]]
name = "DeployPeriphery"
[action.config]
file_contents = """
type Server = { id: string; name: string; version: string; err?: Error };

function sleep(ms: number) { return new Promise(r => setTimeout(r, ms)); }
function parseContainerId(s: string): string | null { const m = s.match(/\b([0-9a-f]{12,64})\b/i); return m ? m[1] : null; }
function normalizeVersion(s: string | undefined | null): string { return String(s ?? "").trim().replace(/^v/i, ""); }

function truthy(v: unknown): boolean {
  if (typeof v === "boolean") return v;
  const s = String(v ?? "").trim().toLowerCase();
  return s === "true" || s === "1" || s === "yes" || s === "on";
}

function parseLimitServers(x: unknown): string[] {
  if (Array.isArray(x)) return x.map(String).map(s => s.trim()).filter(Boolean);
  const raw = String(x ?? "").trim();
  if (!raw) return [];
  try {
    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed)) return parsed.map(String).map(s => s.trim()).filter(Boolean);
  } catch {}
  return raw.split(/[,\s]+/).map(s => s.trim()).filter(Boolean);
}

function extractRecap(s: string): string | null {
  const i = s.indexOf("PLAY RECAP");
  return i >= 0 ? s.slice(i) : null;
}

function recapHasFailures(recap: string): boolean {
  const failed = [...recap.matchAll(/failed=(\d+)/g)].some(([,n]) => parseInt(n,10) > 0);
  const unreachable = [...recap.matchAll(/unreachable=(\d+)/g)].some(([,n]) => parseInt(n,10) > 0);
  return failed || unreachable;
}

async function waitForServerUpdate(server: Server, timeoutMs = 40000, intervalMs = 1000): Promise<boolean> {
  const end = Date.now() + timeoutMs;
  while (Date.now() < end) {
    const { version } = (await komodo.read("GetPeripheryVersion", { server: server.id })) as Types.GetPeripheryVersionResponse;
    if (version === server.version) { console.log(`${server.name} Updated!`); return true; }
    console.debug(`Version: ${version}`)
    await sleep(intervalMs);
  }
  console.log(`${server.name} offline during update... Waiting to come back online...`);
  return false;
}

async function followContainerLogs(server: Server, containerId: string): Promise<string> {
  const term = `periphery-follow`;
  const streamCmd = `docker logs -f ${containerId}`;

  const getRecap = async (): Promise<string | null> => {
    let recapSeen = false;
    let recapText: string | null = null;
    try {
      await komodo.write("CreateTerminal", { 
        server: server.name, 
        name: term, 
        command: "/bin/bash", 
        recreate: Types.TerminalRecreateMode.Always 
      });
      await komodo.execute_terminal({ 
        server: server.name, 
        terminal: term, 
        command: `${streamCmd}` 
        },{
          onLine: (line) => {
            if (!recapSeen) {
              const i = line.indexOf("PLAY RECAP");
              if (i >= 0) {
                recapSeen = true; 
                const first = line.slice(i); 
                recapText = first;
                console.log(first);
              }
            } else {
              console.log(line);
              if (recapText) recapText += `\n${line}`;
            }
          },
          onFinish: () => {},
        }
      );
    } catch {}
    return recapSeen ? recapText : null;
  };

  const first = await getRecap();
  if (first) return first;
  // Server likely dropped out because it is currently updating. 
  // Wait a few seconds, then try to see if it comes back up, then try again
  await sleep(15000);
  const ok = await waitForServerUpdate(server);
  if (!ok) throw new Error(`Timeout waiting for ${server.name} to report version ${server.version}`);
  const second = await getRecap();
  if (!second) throw new Error(`No Ansible recap captured from ${server.name}`);
  return second;
}

async function resolveRequiredVersion(): Promise<string> {
  const req = String(ARGS.KOMODO_VERSION || "");
  if (req.toLowerCase() === "core") {
    const { version } = (await komodo.read("GetVersion", {})) as Types.GetVersionResponse;
    return normalizeVersion(version);
  }
  return normalizeVersion(req);
}

async function isServerOnline(id: string): Promise<boolean> {
  const res = await komodo.read("GetServerState", { server: id }) as Types.GetServerStateResponse;
  return res.status === Types.ServerState.Ok;
}

async function update() {
  const DRY_RUN = truthy(ARGS.DRY_RUN);
  const FORCE = truthy(ARGS.FORCE);
  const LIMIT_SERVERS = parseLimitServers(ARGS.LIMIT_SERVERS);
  const IGNORE_SERVERS = parseLimitServers(ARGS.IGNORE_SERVERS);

  const requiredVersion = await resolveRequiredVersion();
  if (!requiredVersion) throw new Error("Missing required version");

  const base = (await komodo.read("ListServers", { query: {} })) as Types.ListServersResponse;

  const allServers: Server[] = await Promise.all(
    base.map(async ({ id, name }) => {
      try {
        const { version } = (await komodo.read("GetPeripheryVersion", { server: id })) as Types.GetPeripheryVersionResponse;
        return { id, name, version };
      } catch (err) {
        return { id, name, version: "ERROR", err: err as Error };
      }
    })
  );

  const ignoreSet = new Set(IGNORE_SERVERS);
  const unknownIgnores = IGNORE_SERVERS.filter(
    v => !allServers.some(s => s.name === v || s.id === v)
  );
  let servers = allServers.filter(s => !ignoreSet.has(s.name) && !ignoreSet.has(s.id));

  if (IGNORE_SERVERS.length) {
    console.log(`Ignoring servers: ${IGNORE_SERVERS.join(", ") || "(none)"}`);
    if (unknownIgnores.length) console.log(`No match for ignored: ${unknownIgnores.join(", ")}`);
  }

  if (servers.length === 0) {
    console.log("ðŸ¦Ž All servers are ignored. Nothing to do. ðŸ¦Ž");
    return;
  }

  const byName = new Map(servers.map(s => [s.name, s]));
  const limits = LIMIT_SERVERS;
  const unknownLimits = limits.filter(n => !byName.has(n));
  if (limits.length) console.log(`Limiting to: ${limits.join(", ") || "(none)"}`);
  if (unknownLimits.length) console.log(`Ignoring unknown servers: ${unknownLimits.join(", ")}`);

  let candidates: Server[];
  if (limits.length) {
    candidates = limits.map(n => byName.get(n)).filter((x): x is Server => !!x);
    candidates = FORCE ? candidates : candidates.filter(s => !s.err && normalizeVersion(s.version) !== requiredVersion);
  } else if (FORCE) {
    candidates = servers.filter(s => !s.err);
  } else {
    candidates = servers.filter(s => !s.err && normalizeVersion(s.version) !== requiredVersion);
  }

  const targetIds = new Set(candidates.map(s => s.id));
  const labelWidth = Math.max(...servers.map(({ id, name }) => `${name} (id=${id})`.length));

  console.log("Periphery version check:");
  servers.forEach((s) => {
    const label = `${s.name} (id=${s.id})`.padEnd(labelWidth);
    const cur = normalizeVersion(s.version);
    const inScope = targetIds.has(s.id);

    let msg: string;
    if (s.err) {
      msg = `âŒ  Error: ${(s.err as Error).message}`;
    } else if (inScope) {
      if (FORCE && cur === requiredVersion) {
        msg = `ðŸ” forcing update (currently ${cur})`;
      } else if (cur !== requiredVersion) {
        msg = `ðŸŽ¯ target: ${cur} â†’ ${requiredVersion}`;
      } else {
        msg = `âœ… up to date${FORCE ? " (forcing update)" : ""}`;
      }
    } else {
      if (cur !== requiredVersion) {
        msg = `â­ï¸  not targeted (current ${cur}, required ${requiredVersion})`;
      } else {
        msg = `âœ… up to date`;
      }
    }

    console.log(`  - ${label} : ${msg}`);
  });

  if (candidates.length === 0) {
    console.log("ðŸ¦Ž Nothing to do. ðŸ¦Ž");
    return;
  }

  const stack = (await komodo.read("GetStack", { stack: ARGS.STACK_NAME })) as Types.GetStackResponse;
  const stackServerId = (stack as any).config?.server_id as string | undefined;
  const stackServer = servers.find(s => s.id === stackServerId);
  const includesStackServer = !!stackServer && candidates.some(s => s.id === stackServer.id);

  const DETACH = DRY_RUN ? false : includesStackServer;

  const allTargeted = candidates.length === servers.filter(s => !s.err).length;
  const allManaged = servers.filter(s => !s.err);
  let limitPattern: string | undefined;

  if (LIMIT_SERVERS.length || IGNORE_SERVERS.length) {
    limitPattern = candidates.map(s => s.name).join(",");
  } else {
    const allTargeted = candidates.length === allManaged.length;
    limitPattern = allTargeted ? undefined : candidates.map(s => s.name).join(",");
  }
  
  const command = [
    "ansible-playbook",
    ARGS.PLAYBOOK,
    "-i", ARGS.INVENTORY,
    "-e", `komodo_action=${ARGS.KOMODO_ACTION}`,
    "-e", `komodo_version=v${requiredVersion}`,
    "-e", "pause_after=true",
  ];
  if (limitPattern) command.push("-l", limitPattern);
  if (DRY_RUN) command.push("--check", "--diff");

  const result = (await komodo.execute_and_poll("RunStackService", {
    stack: ARGS.STACK_NAME,
    service: ARGS.SERVICE_NAME,
    command,
    detach: DETACH,
    pull: true,
    no_deps: true,
    env: { VAULT_PASS: "[[VAULT_PASS]]" },
  })) as Types.Update;

  const runLog = result.logs.find(l => l.stage === "Compose Run");
  if (!runLog) throw new Error("No 'Compose Run' stage found in logs.");

  let recapText: string | null = null;

  if (DETACH && stackServer) {
    // Detached: stdout/stderr should contain the container id; follow its logs to get the recap
    const cid = parseContainerId(`${runLog.stdout || ""}\n${runLog.stderr || ""}`);
    if (!cid) throw new Error("Could not parse container id from output; unable to follow logs.");

    console.log(`Following container logs (${cid}) on ${stackServer.name}â€¦`);

    // we expect this host to update to requiredVersion
    stackServer.version = requiredVersion;

    recapText = await followContainerLogs(stackServer, cid);
  } else {
    // Non-detached: compose output should include the recap
    if (!runLog.success) {
      console.error(runLog.stdout);
      console.error(runLog.stderr);
      throw new Error("Periphery Update Failed");
    }
    recapText = extractRecap(runLog.stdout) ?? extractRecap(runLog.stderr || "");
    if (!recapText) throw new Error("Ansible run completed but recap was not found in output.");
    console.log(recapText);
  }

  if (recapHasFailures(recapText)) throw new Error("Ansible recap indicates failures.");

  if (!DRY_RUN) {
    const offline = await Promise.all(
      candidates.map(async s => ({ s, ok: await isServerOnline(s.id) }))
    ).then(rows => rows.filter(r => !r.ok).map(r => r.s.name));
    if (offline.length) throw new Error(`Post-update check failed: offline servers: ${offline.join(", ")}`);
  }

  console.log("ðŸ¦Ž Periphery Update Successful ðŸ¦Ž");
}

await update();
"""
arguments_format = "json"
arguments = """
{
  "PLAYBOOK": "/ansible/playbooks/komodo.yml",
  "INVENTORY": "/ansible/inventory/komodo.yml",
  "KOMODO_VERSION": "core",
  "STACK_NAME": "komodo-ee",
  "SERVICE_NAME": "ansible",
  "DRY_RUN": false,
  "FORCE": false,
  "LIMIT_SERVERS": [],
  "IGNORE_SERVERS": []
}
"""

##

[[builder]]
name = "kmd0"
[builder.config]
type = "Server"
params = {}

##

[[resource_sync]]
name = "sync"
[resource_sync.config]
linked_repo = "dIIIhl"
resource_path = ["komodo/all.toml"]
managed = true